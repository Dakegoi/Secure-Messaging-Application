<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reset Password - Secure Messaging</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="app">
      <header>
        <h1>Secure Messaging</h1>
        <p>Reset your password</p>
      </header>
      <section class="auth" id="reset-page">
        <div class="card">
          <h2>Enter reset code</h2>
          <p class="muted">
            A 4-digit reset code was generated for your email (shown in the
            forgot password screen in this demo). Enter it here with your new
            password.
          </p>
          <form id="reset-form">
            <label>Email <input type="email" name="email" id="reset-email" required /></label>
            <label>Reset code <input type="text" name="code" maxlength="4" required /></label>
            <label>New password <input type="password" name="new_password" required /></label>
            <button type="submit">Change password</button>
          </form>
          <p class="muted">
            <a href="/">Back to home</a>
          </p>
        </div>
      </section>
      <div id="toast" class="toast hidden"></div>
    </div>
    <script type="module">
      const API_BASE = '/api';
      const toast = document.getElementById('toast');
      const form = document.getElementById('reset-form');
      const emailInput = document.getElementById('reset-email');

      function showToast(message, isError = false) {
        toast.textContent = message;
        toast.classList.remove('hidden', 'error');
        if (isError) toast.classList.add('error');
        setTimeout(() => toast.classList.add('hidden'), 2500);
      }

      async function api(path, { method = 'GET', body } = {}) {
        const headers = { 'Content-Type': 'application/json' };
        const res = await fetch(`${API_BASE}${path}`, {
          method,
          headers,
          body: body ? JSON.stringify(body) : undefined,
        });
        if (!res.ok) {
          const detail = await res.json().catch(() => ({}));
          throw new Error(detail.detail || 'Request failed');
        }
        return res.json();
      }

      // If email provided in query string, prefill it
      const params = new URLSearchParams(window.location.search);
      const email = params.get('email');
      if (email) {
        emailInput.value = email;
      }

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const data = Object.fromEntries(new FormData(form));
        if (!data.email || !data.code || !data.new_password) {
          showToast('Email, code and new password are required', true);
          return;
        }
        try {
          await api('/reset-password', { method: 'POST', body: data });
          showToast('Password changed. You can now log in.');
          form.reset();
        } catch (error) {
          showToast(error.message, true);
        }
      });
    </script>
  </body>
</html>
